<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Search - Liveplay</title>
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
    <link rel="manifest" href="/assets/site.webmanifest" />
    <link href="https://fonts.cdnfonts.com/css/tt-hoves-pro-trial" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200,0..1,0" />
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>
<body class="subpage">
    <header class="subpage-header">
        <a href="/home" class="back-link">
            <span class="material-symbols-outlined">arrow_back_ios_new</span>
        </a>
        <h1>Search</h1>
    </header>

    <main class="subpage-content search-container">
        <div class="search-bar">
            <span class="material-symbols-outlined">search</span>
            <input type="text" id="search-input" placeholder="Search for channels..." autocomplete="off" autofocus>
        </div>

        <div id="search-results">
             <p id="initial-message">Start typing to find your favorite channels.</p>
        </div>
    </main>

        <div id="auth-popup-overlay" class="auth-popup-overlay">
            <div class="auth-popup">
                <button id="close-popup" class="popup-close-btn">
                <span class="material-symbols-outlined">close</span>
                </button>
                <img src="/assets/liveplay-logo-white.png" alt="Liveplay Logo" class="popup-logo">
                <p class="popup-subtitle">Join to Watch Free</p>
                <a href="/home/login" class="popup-action-btn">Log In or Sign Up</a>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/yt-live.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            const initialMessage = document.getElementById('initial-message');
            let allStreams = [];
    
            try {
                const response = await fetch('/api/getChannels');
                if (!response.ok) throw new Error('Failed to fetch channel list');
                const publicStreams = await response.json();
                
                allStreams = [...publicStreams, ...yt_live];
            } catch (error) {
                console.error("Could not load channel list for search:", error);
                
                allStreams = [...yt_live]; 
                searchResultsContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.8rem; text-align: center;">Could not load full channel list. Search may be limited.</p>';
            }
    
            const authPopup = document.getElementById('auth-popup-overlay');
            const closePopupBtn = document.getElementById('close-popup');
            let currentUser = await window.auth.getCurrentUser();
    
            window.auth.onAuthStateChange(async (_event, session) => {
                if (session) {
                    currentUser = await window.auth.getCurrentUser();
                } else {
                    currentUser = null;
                }
            });
    
            const showAuthPopup = () => {
                if (authPopup) authPopup.classList.add('active');
            };
    
            const hideAuthPopup = () => {
                if (authPopup) authPopup.classList.remove('active');
            };
    
            if (authPopup) {
                authPopup.addEventListener('click', (e) => {
                    if (e.target === authPopup) hideAuthPopup();
                });
            }
            if(closePopupBtn) {
                closePopupBtn.addEventListener('click', hideAuthPopup);
            }
    
            const popupActionBtn = document.querySelector('.popup-action-btn');
            if (popupActionBtn) {
                popupActionBtn.addEventListener('click', (e) => {
                    e.preventDefault();
    
                    popupActionBtn.classList.add('clicked');
    
                    const destination = popupActionBtn.href;
    
                    setTimeout(() => {
                        window.location.href = destination;
                    }, 200);
                });
            }
    
            const categoryIcons = { ALL: 'apps', General: 'tv_gen', News: 'news', Entertainment: 'theater_comedy', Movies: 'theaters', Sports: 'sports_basketball', Kids: 'smart_toy', Infotainment: 'emoji_objects', 'Lifestyle + Food': 'restaurant', Music: 'music_note', 'Action + Crime': 'local_police', 'Nature + Animal': 'pets', Overseas: 'globe', Religious: 'church', 'PBB Livestream': 'visibility', 'YouTube Live': 'smart_display' };
    
            const renderResults = (results) => {
                searchResultsContainer.innerHTML = '';
                if (results.length === 0) {
                    searchResultsContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.8rem; text-align: center; width: 100%; padding: 50px 0;">No channels found.</p>';
                    return;
                }
    
                const groupedByCategory = results.reduce((acc, stream) => {
                    (acc[stream.category] = acc[stream.category] || []).push(stream);
                    return acc;
                }, {});
    
                for (const category in groupedByCategory) {
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    
                    const title = document.createElement('div');
                    title.className = 'category-title';
                    title.innerHTML = `<span class="material-symbols-outlined">${categoryIcons[category] || 'emergency'}</span><h3>${category}</h3>`;
                    section.appendChild(title);
    
                    const row = document.createElement('div');
                    row.className = 'channel-row';
                    
                    groupedByCategory[category].forEach(stream => {
                        const card = document.createElement('div');
                        card.className = 'channel-card';
                        card.innerHTML = `<div class="channel-logo-bg"><img src="${stream.logo}" alt="${stream.name}" class="channel-logo"></div>`;
                        card.addEventListener('click', () => {
                             if (currentUser) {
                                const channelName = encodeURIComponent(stream.name.replace(/\s+/g, '-'));
                                window.location.href = `/home?play=${channelName}`;
                             } else {
                                showAuthPopup();
                             }
                        });
                        row.appendChild(card);
                    });
    
                    section.appendChild(row);
                    searchResultsContainer.appendChild(section);
                }
            };
    
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                initialMessage.style.display = 'none';
    
                if (query.length > 0) {
                    const filteredStreams = allStreams.filter(stream => stream.name.toLowerCase().includes(query));
                    renderResults(filteredStreams);
                } else {
                    searchResultsContainer.innerHTML = '';
                    initialMessage.style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>
